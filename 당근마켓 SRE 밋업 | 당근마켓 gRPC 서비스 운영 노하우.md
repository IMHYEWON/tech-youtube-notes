#  λ‹Ήκ·Όλ§μΌ“ gRPC μ„λΉ„μ¤ μ΄μ λ…Έν•μ° | λ‹Ήκ·Όλ§μΌ“ SRE λ°‹μ—… 1ν 
[ λ‹Ήκ·Όλ§μΌ“ gRPC μ„λΉ„μ¤ μ΄μ λ…Έν•μ° | λ‹Ήκ·Όλ§μΌ“ SRE λ°‹μ—… 1ν ](https://www.youtube.com/watch?v=igHrQPzLVRw)


## λ‹Ήκ·Ό λ§μΌ“μ κ³Όκ±°/ν„μ¬
- ν„μ¬ λ‹Ήκ·Ό λ§μΌ“
  - http (non gRPC) 75k rps
  - gRPC 60k rps
  - 5κ°μ λ€ν‘ MSA κµ¬μ„± (Java, Ruby, Go, NodeJS, Python)
  - μ μ  gRPC μ„λΉ„μ¤λ“¤μ΄ λμ–΄λ‚λ” μ¤‘
 
- λ λ²„λ¦¬μ§€λ¥Ό μ μ‚¬μ©ν•μ
  - λ λ²„λ¦¬μ§€κ°€ λ­μ§€..?
  - *SRE(μ‚¬μ΄νΈ μ‹ λΆ°μ„± μ—”μ§€λ‹μ–΄λ§, Site Reliability Engineering)μ—μ„ "λ λ²„λ¦¬μ§€(Leverage)"λΌλ” μ©μ–΄λ” λ³΄ν†µ ν¨μ¨μ„±μ΄λ‚ ν¨κ³Όμ„±μ„ κ·Ήλ€ν™”ν•κΈ° μ„ν• λ„κµ¬λ‚ λ°©λ²•λ΅ μ„ μλ―Έ*
  - ν¨μ¨μ μΈ λ„κµ¬, λ°©λ²•λ΅ , μλ™ν™”λ¥Ό ν†µν•΄ μƒμ‚°μ„± ν–¥μƒ -> μλ™ν™” μ¤ν¬λ¦½νΈ, CI/CD νμ΄ν”„λΌμΈ, λ¨λ‹ν„°λ§ λ° μ•λ¦Ό μ‹μ¤ν… κµ¬μ¶•
- νΈλν”½ ν”λ΅μ°λ¥Ό μ΄ν•΄ν•λ ¤λ” λ…Έλ ¥
  - Connectionμ΄ μλ” ALB
  - Active Flowκ°€ μλ” NLB
  - κ° κµ¬κ°„λ³„λ΅ μ–΄λ–»κ² ν¨ν‚·μ΄ μ¤κ³ κ°€λ”μ§€ μ•κΈ°
  - μ‚¬μ©ν•  ν”„λ΅μ‹μ— λ€ν•΄ μ΄ν•΄ lptablesL ipvs, μ‚¬μ©ν•  cni ν†µμ‹ λ°©μ‹ μ΄ν•΄
  - μΏ λ²„λ„¤ν‹°μ¤ λ„¤νΈμ›ν¬ λ°©μ‹ μ΄ν•΄
  - κ° κµ¬κ°„λ³„ λ©”νΈλ¦­ μ¤€λΉ„ (μ΄μ λ°μƒκµ¬κ°„μ„ λΉ¨λ¦¬!)
- λ™μΌ ν™κ²½μ„ κ°€μ§„ sre-test-serverλ¥Ό κµ¬μ¶•
  - λ„¤νΈμ›ν¬ μ΄μ λ””λ²„κΉ… (λ””λ²„κΉ… λ¨λ“λ΅ λ™μ‘)
  - λ³€ν™” μ„ μ  μ μ©
- gRPC μΈν”„λΌ κµ¬μ„±
  - haProxy -> NLB -> Istio Ingress/ Service Mesh
 
## gRPC 
- protobufλ¥Ό μ΄μ©ν•΄ JSON λ³΄λ‹¤ μ„±λ¥
- latency
- μ„λΉ„μ¤ μΈν„°νμ΄μ¤ μ¤ν‚¤λ§
- λ‚΄μ¥ κΈ°λ¥ ν’λ¶€ (μΈμ¦, μ•”νΈν™”)

### gRPC ν΄λΌμ΄μ–ΈνΈ μ„λ²„
- HTTP2λ¥Ό μ΄μ©ν• gRPC μ±„λ„μ΄λΌλ” λ€ν‘μ μΈ μ»¨μ…‰
  - HTTP/2 μ—”λ“ν¬μΈνΈμ— λ€ν• virtual connectionμ„ λ‚νƒ€λƒ„
- ν΄λΌμ΄μ–ΈνΈκ°€ gRPC μ±„λ„μ„ λ§λ“¤λ©΄ λ‚΄λ¶€μ μΌλ΅ HTTP2 μ»¤λ„¥μ… μƒμ„±λ¨
- RPCλ” HTTP2μ μ¤νΈλ¦ΌμΌλ΅ μ²λ¦¬ λ¨
- λ©”μ‹μ§€λ” HTTP2μ ν”„λ μ„λ‹¨μ„λ΅ μ²λ¦¬κ°€ λ¨
- μ±„λ„μ—λ” λ§μ€ RPCκ°€ μμ„ μ μκ³ , RPCμ—λ” λ§μ€ λ©”μ‹μ§€κ°€ μμ„ μ μμ
- HTTP2μ μ¤νΈλ¦Όμ€ Multi Concurrent Conversationμ„ μ§€μ›ν•κΈ° λ•λ¬Έμ— μ‹±κΈ€ μ»¤λ„¥μ…μ—μ„ κ°€λ¥
- μ±„λ„μ€ μ‚¬μ©μκ°€ ν‘λ©΄μ μΌλ΅ μ†μ‰½κ² λ©”μ‹μ§€λ¥Ό λ³΄λ‚Όμ μλ” μ‰¬μ΄ μΈν„°νμ΄μ¤ μ κ³µ
- **μ±„λ„μ€ ν•λ‚μ μ—”λ“ν¬μΈνΈμ— λ€ν• virtual μ»¤λ„¥μ…μ„ ν‘μ‹ν•μ§€λ§, μ‹¤μ λ΅λ” λ§μ€ http2 μ»¤λ„¥μ…μ— μν•΄ μ§€μ›λ  μ μμ**
- gRPC ν΄λΌμ΄μ–ΈνΈλ” resolverμ™€ LBλ¥Ό λ“¤κ³  μμ
  - λ¦¬μ΅Έλ²„λ” μ£ΌκΈ°μ μΌλ΅ νƒ€κ² DNSλ¥Ό λ¦¬μ΅ΈλΈν•λ©΄μ„ μ—”λ“ν¬μΈνΈλ“¤μ„ κ°±μ‹ 
  - μ»¤λ„¥μ…μ΄ μ‹¤ν¨ν•λ©΄ λ΅λ“λ°Έλ°μ„λ” μ§μ „μ— μ‚¬μ©ν–λ address λ¦¬μ¤νΈλ“¤μ„ μ‚¬μ©ν•μ—¬ μ¬μ—°κ²°μ„ μ‹μ‘
  - -> μΈν”„λΌ μ΄μμ— μ•μ •μ μΈ λ³µμ›λ ¥(λ μ§λ¦¬μ–Έμ¤)μ„ μ§€μ›
  - μ»¤λ„¥μ… ν’€μ„ κ΄€λ¦¬
- gRPC Keepalive
  - KeepALive HTTP/2 ping ν”„λ μ„μ„ λ³΄λ‚΄ μ—°κ²°μƒνƒλ¥Ό μ£ΌκΈ°μ μΌλ΅ ν™•μΈν•κ³ , μ»¤λ„¥μ…μ„ μ‚΄λ¦¬λ” μ—­ν• μ„ ν•¨
  - ping frame μ „λ‹¬ μ‹ μ‘λ‹µμ΄ μ λ• μ¤μ§€ μ•μΌλ©΄ μ—°κ²° μ‹¤ν¨λ΅ κ°„μ£Όν•κ³  μ»¤λ„¥μ… ν΄λ΅μ¦
  - ν”„λ΅μ‹ μ„λ²„λ“¤μ€ λ³΄ν†µ λ¦¬μ†μ¤λ¥Ό μ μ•½ν•κΈ° μ„ν•΄ idle connectionμ„ μΆ…λ£μ‹ν‚¤κΈ°λ„ ν•¨, νƒ€μ„μ•„μ›ƒλ³΄λ‹¤λ” μ μ€ μ‹κ°„μΌλ΅ keepalive μ„Έν…
  - gRPCκ°€ μ—°κ²°μ—μ„ μ£ΌκΈ°μ μΌλ΅ ν•‘ ν”„λ μ„μ„ μ „μ†΅ν•λ©΄ ν•΄λ‹Ή connectionμ€ not idle μƒνƒκ°€ λ¨
- gRPC μ”μ²­κ³Ό μ‘λ‹µ ν”„λ μ„ λ””λ²„κΉ… λ¨λ“μ—μ„ ν™•μΈν•΄λ³΄κΈ°
  - μ”μ²­ (ν—¤λ” + λ°”λ””)
  - μ‘λ‹µ (ν—¤λ” + λ°μ΄ν„°λ°”λ””:length prefixed Message + νΈλ μΌλ¬ ν—¤λ”)
    - νΈλ μΌλ¬ : http μ¤ν™μ¤‘ μΌλ¶€λ΅ grpc status, grpc-messageλ¥Ό ν¬ν•¨ν•¨
    - μ–΄ν”λ¦¬μΌ€μ΄μ…μ— μ‘λ‹µμ„ μ μ£Όμ—λ”μ§€ ν™•μΈν•κΈ° μ„ν•΄ μ²΄ν¬
    - **gRPC Status Code** : μ–΄ν”λ¦¬μΌ€μ΄μ… λ λ²¨, μΈν”„λΌ λ λ²¨μ—μ„ ν•Έλ“¤λ§ν•΄μ•Όν•λ” statusκ°€ λ¶„λ¦¬λμ–΄ μμ
      - http μ‘λ‹µμΌλ΅ λΉ λ¦¬μ¤νΈκ°€ μ™”μ„λ• μμ›μ΄ μ—†μΌλ‹ 404..? μ •μƒμ΄λ‹ 200...??? -> μ΄λ° κ³ λ―Όλ“¤μ΄ λ³΄κ°•λ¨
    - ν”„λ΅λ©”ν…μ°μ¤μ λ‹¤μ°¨μ› λ©”νΈλ¦­μ„ μ‚¬μ©ν•΄μ„ error λ¨λ‹ν„°λ§
    - κ°λ°μ λ μ΄μ–΄μ—μ„λ” μ»¤μ¤ν…€ν•κ² μ„λΉ„μ¤μ— λ§λ” λ€μ‹λ³΄λ“λ¥Ό μ„Έν…

### gRPC λ΅λ“λ°Έλ°μ‹±
- μ¤νΈλ¦Ό λ² μ΄μ¤μ λ°Έλ°μ‹±, L7λ² μ΄μ¤μ λ°Έλ°μ‹±μ΄ ν•„μ”ν•λ‚, *μΏ λ²„λ„¤ν‹°μ¤λ” L4*μ΄κΈ° λ•λ¬Έμ— gRPC μ”μ²­λ¶„λ°°μ— μμ–΄ μ μ¬μ  λ¬Έμ μ„
  - L4 : μ»¤λ„¥μ… λ² μ΄μ¤λ“, L7 : μ¤νΈλ¦Ό λ² μ΄μ¤λ“
- μ”μ¦ proxyλ“¤μ€ k8s gRPC μ„λΉ„μ¤λ¥Ό λ΅λ“λ°Έλ°μ‹±ν• λ•, μ„λΉ„μ¤ κ°μ²΄λ¥Ό μ—”λ“μΈνΈ μ£Όμ† κ°±μ‹ μ©λ„λ΅ μ‚¬μ©ν•¨


### SREλ΅μ„ ν•΄μ•Όν• ..
- λ¨λ‹ν„°λ§ μ „μ—­ μΏΌλ¦¬ λ””μμΈ
- νΈλν”½ ν”λ΅μ° κ΄€λ ¨ κµ¬κ°„λ³„ μ£Όμ” λ©”νΈλ¦­ λ³΄κ°•
- μΈν”„λΌ κµ¬μ„±μ„ κ³ λ ¤ν• gRPC μµμ… κ°€μ΄λ“ for κ°λ°μ

### κ°λ°μλ΅μ„ ν•΄μ•Όν• ..
- μ„λΉ„μ¤μ νΉμ„±μ— λ§λ” option μ μ©
  - keep-alive, max timeout,... λ“±
- Intercepter ν¨ν„΄ ν™μ©, AOP λ΅κΉ…, λ¨λ‹ν„°λ§
- κ° μ„λΉ„μ¤λ¥Ό μ„λ΅ λ³΄νΈν•΄μ¤„ μ μλ” DeadLine μ„¤μ •

### μ΄κΈ° μ„Έν…μ‹
- Connection testν•λ©΄μ„ Reflection λ„£κΈ°
- k6, Ghzλ¥Ό ν™μ©ν• Load test

## ν•¨κ» μΌν•κΈ°
- μ‹¤μ ν•  μ μλ” ν™κ²½μ„ λ§λ“¤κΈ° -> λ©‹μλ” λ§μΈλ“.. λ‚λ„ κ°™μ΄ μΌν•κ³ μ‹¶λ‹¤.. π¥Ή
- ν΄λΌμ°λ“μ—μ„ rollback, resilienceμ— μ΄μ μ„ λ‘” ν™κ²½μ„¤μ •


