# 클라우드 환경에서의 Kafka 운영기
[ 클라우드 환경에서의 Kafka 운영기 #우아콘2022 #Day2_음식그이상의것을문앞으로 ](https://youtu.be/XyuqoWUCdGA?si=eCvbdeoxjQeY3K8u)

# 카프카와 클라우드 환경의 특징
## 카프카의 기분적인 구조
- 토픽은 병렬처리를 위해 파티션 단위로 구성
- 파티션은 아정성을 위해 레플리카로 복제 구성 (여러 브로커에 분산되어 있음)
### 상태기반 시스템 (Stateful)
- 발행되는 메시지는 **브로커의 파일 시스템에 저장**
  - 토픽 파티션 별 로그 세그먼트에 메시지가 저장됨
- 브로커가 토픽 파티션의 메시지를 저장하고 있다
  - = 브로커가 토픽 파티션의 레플리카를 가지고 있다
  - = 브로커가 토픽 파티션의 상태(State)를 가지고 있다.
- 하지만 상태를 자동으로 옮기지 않는다!
  - 카프카는 브로커가 가지고 있는 레플리카를 다른 브로커를 임의를 옮기지 않는다
  - = **운영자가 상태를 관리해줘야 한다**
 
## 클라우드 환경의 특징
- 필요한 리소스를 원하는 만큼 구성하기 쉽다.
- 그러나! **추적/예상하기 어려운 인프라 이슈**

### 실제 이슈 사례
- 현상 : 특정 브로커의 갑작스러운 종료, 클러스터의 성능 저하
- 원인 : EC2 underlying hardware -> 이슈를 추적하기 어려움
- 운영자 입장 : 브로커가 죽으면 모든 작업 ALL STOP
  - 클라이언트 쪽 영향도 확인
  - 이슈 원인 파악
  - 안정성을 위해 레플리카를 옮겨주기 등 후속 작업

# 우아한형제들의 카프카
## 카프카 클러스터 규모 (2022년 8월)
- 클러스터 27대, 브로커 162대
  - 2020년 12월 기준 브로커 41대
- 파티션 약 24,000개
- 메시지 초당 약 50만개

## 카프카를 사용하는 서비스들
- 메시지 플랫폼
- 라이더 배차 시스템
- 데이터 플랫폼

## 점점 커지는 규모로 인한 고민
- 인스턴스 수가 늘어날 수록 관리 포인트가 많아지며, 이슈 발생 빈도가 더 증가

=> 어떻게 하면 안정적이고 효율적으로?

# 운영 중 겪었던 이슈와 개선
## 이슈 1. 단일 주키퍼 클러스터
### 초기 카프카 클러스터 구성
- 사내 서비스들은 MSA기반으로 개별적으로 구성됐고, 카프카 클러스터도 각 서비스 별로 구성
- 도입 초기엔 *하나의 주키퍼 클러스터에 여러 카프카 클러스터를 구성*
- 점점 주키퍼에 등록되는 카프카 클러스터가 증가하며 하나의 주키퍼에 의존도가 높아지며 -> 단일 장애지점 (SPOF) 가 됨!

### 개선 1. 격리된 클러스터 구성
- 주키퍼 클러스터도 서비스 별 격리된 환경으로 구성
- 주키퍼:카프카 = 1:1

## 이슈 2. 업데이트가 어려워!
### 점점 어려워지는 카프카 업데이트
- 다양한 상황 (Read-Only 설정, 보안 패치등)에 업데이트가 필요하지만 가장 대표적인 방법인 *롤링 업데이트*는 관리할 브로커가 점점 많아지면 어렵다.
- 롤링 업데이트의 한계
  - 동작하고 있는 브로커를 내려야 하는 부담감
    - 복제는 잘 되었나? 클라이언트 이슈는 없나?...
    - 래풀리카 구성이 되어있다고 해도 절체하는데 부담
   
  - +) 클라우드 환경
    - 언제 인스턴스 실패가 발생할지 모름
    - 롤링 업데이트 중 다른 인스턴스에 이슈가 생기면 일시적인 다운타임이 발생
### 개선 2. 카프카 클러스터 내에 논리적인 스택 구성
- 브로커 ID를 기준으로 논리적인 스택 구성 => 블루 그린 방식으로 
  - Blue : 1 ~ 1000
  - Green : 1001 ~ 2000
 
- 트래픽이 있는 프로세스를 종료하지 않아 안정적
- 브로커가 많아질 수록 더 쉽고 간단함
- 신규 브로커 프ㄹㅎ비저닝 완료 > 파티션 완료 > 기존 브로커 제거


## 이슈 3. 카프카 스트림즈의 상태 깨짐
### 카프카 스트림즈의 상태 관리
- 스트리밍 집계를 위해 사용되는 스트림즈
- 상태 정보를 로컬과 토픽에 저장
- 다양한 원인으로 상태 깨짐이 발생될 수도
  - 브로커의 갑작스러운 종료
  - 클라이언트 네트워크 이슈

#### 실제 이슈 사례
- 주키퍼와 브로커가 일시적으로 통신이 불안정해 브로커가 클로스터에서 갑작스레 제외
  - -> 스트림즈가 상태 반영을 제대로 하지못함

### 개선 3. 상태 복구 툴 활용
- kafka-streams-application-reset.sh 스크립트를 이용한 복구
- 관련된 스트림 어플리케이션 종료 > 특정 시점 부터 스트림즈 어플리케이션 리플레이
<img width="657" alt="image" src="https://github.com/IMHYEWON/tech-youtube-notes/assets/37797830/8a82078e-b556-4402-a40f-00cb53b4fbef">
- 어플리케이션을 중지하고 스크립트를 실행하기 위해 공수가 필요해 효율적인 방법 
