# 토스 | SLASH 22 - 왜 은행은 무한스크롤이 안되나요
[토스 | SLASH 22 - 왜 은행은 무한스크롤이 안되나요](https://www.youtube.com/watch?v=v9rcKpUZw4o)

## 기존 은행 시스템의 구조
기존 은행 시스템은 무한 스크롤 조회가 아닌 상단에 조회기간을 사용자가 설정해야하는 불편한 조회구조를 가지고 있다. 왜?

- 기존 은행시스템
  - 은행 앱 ←→ 채널계 ←→ 계정계
  - 계정계 : 실제 유저의 돈을 다룸, 원본 데이터 저장영역, **장애 발생 시 치명적**, 매우 높은 신뢰도 요구됨
  - 채널계 : 유저의 요청을 받아 처리하는 영역, 요청을 계정계로 전달
 
## 토스뱅크 시스템의 구조
  - 마찬가지로 채널계와 계정계로 분리
  - 채널계 : 쿠버네티스 환경위에 여러개의 서버 및 DB (성능 중심)
    - ⛔️ : 네트워크 처리가 복잡함, 트랜잭션 처리에 유의
    - ✅ : DB 및 서버 스펙업이 쉬움
  - 계정계 : 하나의 코어뱅킹 서버 및 하나의 DB (신뢰도 중심)
    - ✅ : 네트워크 처리가 단순, 트랜잭션 처리에 유리
    - ⛔️ : 특정 서버나 DB분리가 어려워서 급증 트래픽에 불리
    - 성능을 희생하더라도 단순한 아키텍처가 필요
- 높은 신뢰성을 위해 기간 설정을 하게 됨
- **그러나 토스뱅크는 무한 스크롤이 됨!**

### 토스뱅크의 거래내역 조회
- 토스뱅크에서는 거래내역을 조회할 때 코어뱅킹 서버까지 요청이 가지않고, *송금 서버에서 직접 반환*
- 이런 구조를 가지려면, 채널계의 송금서버가 코어뱅킹서버와 항상 **동기화** 되어야 함
- 동기화가 늦어지면 신뢰도가 떨어지고, 동기화가 너무 잦으면 코어뱅킹 서버에 무리가 감
- 어떻게 해결??


## 토스뱅크의 동기화 해결 방법
1. 타 은행 → 토스뱅크
유저가 이체할 때마다 전부 송금서버의 DB에 저장
- ❗️이체하는 경우는 괜찮지만, 다른 은행에서 토스뱅크로 입금한 경우는 동기화가 안됨
- 👉 코어뱅킹 서버에 입금이 되었을 때 이를 송금 서버에 알려주어야 함.
- 👉 **kafka**를 이용해 코어뱅킹서버는 Producing, 송금서버는 이를 Consuming
2. 토스뱅크 → 타 은행
송금을 실행하는 도중, 코어뱅킹 서버에 타임아웃이 나서 송금서버가 응답을 받지 못한다면?
- ❗️유저는 송금이 성공했더라도 거래내역을 볼수없음
- 👉 코어 뱅킹 서버에서 송금이 완료되면 **kafka**로 송금 완료 producing
3. 타임 아웃으로 인해 유저가 중복 송금할 가능성
- 재요청이 들어온 경우, 송금 서버는 송금 요청 이력을 우선 DB에 저장
- 완료되지 않은 송금이 있는 유저가 재 송금 요청을 보내면 거절
- 송금 완료 후 송금 이력까지 저장되면 송금 요청을 허락
- ❗️ 송금이 영원히 지연될 수 있는 문제
  - 송금서버로 보낸 송금 요청이 **코어뱅킹 서버로 도달하지 못한다면** 송금요청은 여전히 진행중인 상태로 송금 DB에 남게 됨
- 👉 송금 서버는 주기적으로 코어뱅킹 서버에게 주기적으로 요청을 확인
  - 코어뱅킹서버에서 송금이 없다고 응답하면, 송금 서버는 송금 실패처리 → 지연 해결
4. 간혹가다가 송금서버에서 송금실패로 판단했는데, 뒤늦게 코어뱅킹서버에 응답이 도착한 경우
- ❗️ 중복 송금이 요청될 가능성!
- 👉 타임아웃 리밋을 두고 그보다 오래된 요청은 거절하기로 약속
5. Kafka로 전달받은 송금완료여부를 *저장할 때* 에러가 발생한다면
- 송금 완료 메시지를 다시 컨슘해서 재저장 (Retry)
- ❗️ Retry해도 일시적인 네트워크가 아닌 문제가 있을 경우 계속 실패함
- 👉 Dead Letter queue에 프로듀싱
- 개발자가 직접 확인 후 문제 해결
6. 송금 이력이 누락되는 문제
- ❗️A 출금 이벤트, B 입금 이벤트가 각각 실행됐으나 B응답이 늦게와 거래내역에는 A응답만 조회되는 경우
- 👉 송금 완료 카프카 메시지를 받았을 때 해당 이벤트만 동기화하지 않고, 이전 내역까지 조회해서 함께 동기화
- 👉 카프카 메시지 내 이벤트 일련번호와 코어뱅킹 서버 조회내역의 일련번호를 비교
7. 방금 출금한 거래가 조회되지 않는 문제
- 순서 보장을 위해, A 출금 응답을 받았는데, B 입금 응답을 받지 못한 경우 A이벤트도 함께 동기화 하지않는다
- ❗️ 출금 했는데도 출금한 이력이 보이지 않는다면 유저는 당황할 것
- 👉 송금서버는 거래내역을 저장하는데, 유저가 조회할 때 아직 진행중인 이벤트가 있으면 그때 코어뱅킹 서버에 요청을 보내면 그 즉시 동기화
- 👉 A, B 내역 둘다 동기화 됨
8. 동기화가 지연되는 문제 (한번에 많은 이벤트가 발생할 때)
- 타행 → 코어뱅킹 서버 → (Kafak) → 송금서버 : 동기화 순차적으로 진행
- ❗️ 수많은 요청을 빠르게 처리하지 못해 지연이 생김
- 👉 Kafka 파티션을 늘려 여러 컨슈머가 처리
- 👉 계좌번호 같은 특정 키로 파티션을 분리해 순서 보장 및 동시성 문제 해결
9. 유저가 더 늘어나면서 더 높은 처리량이 필요할 때
- ❗️ 파티션으로는 해결이 어려움
- 👉 파티션 수는 적절한 수를 조정하고, 컨슈머당 워커 스레드 100개 (concurrency 100으로 했다는 뜻인가?)
- 👉 계좌번호를 키로 가져 같은 계좌는 항상 같은 스레드가 처리해 중복으로 처리하는 문제를 방지
10. 직접 동기화 버튼 (최후의 수단)

